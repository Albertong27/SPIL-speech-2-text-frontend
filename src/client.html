<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speech to Text</title>

    <!-- tailwind -->
    <link href="./input.css" rel="stylesheet" />
    <link href="./output.css" rel="stylesheet" />

    <!-- font poppins and roboto mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- font awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
  </head>

  <body class="font-poppins">
    <section class="flex">
      <!-- left side -->
      <div
        class="flex h-screen w-[35%] flex-col rounded-r-xl border-r-2 border-gray-300"
      >
        <div class="w-full">
          <!-- search bar -->
          <div class="h-[15vh]">
            <div
              class="z-50 flex h-[15vh] w-full items-center justify-center rounded-tr-xl px-10"
            >
              <label
                class="input input-bordered flex w-full items-center gap-2 rounded-lg"
              >
                <input type="text" class="grow" placeholder="Search" />
                <i class="fas fa-search fa-sm" style="color: #697079"></i>
              </label>
            </div>
          </div>

          <!-- transcription result -->
          <div class="h-[70vh] !overflow-auto">
            <div class="relative flex h-full flex-col justify-end">
              <div class="space-y-6 overflow-auto px-10" id="transcription">
                <div id="getDate"></div>
                <p>
                  <span class="font-semibold" id="final"></span>
                  <span class="text-gray-300" id="interim"></span>
                </p>
              </div>
            </div>
          </div>

          <div class="fixed bottom-0 h-[15vh] w-[35%] rounded-br-xl">
            <div class="flex h-[15vh] items-center justify-between px-10">
              <!-- start record -->
              <button
                class="btn btn-primary w-fit flex-none rounded-lg"
                id="startListening"
                onclick="startAndStopListening('start')"
              >
                <i
                  class="fa-solid fa-microphone fa-sm"
                  style="color: #ffffff"
                ></i>
                Start Listening
              </button>

              <div class="flex gap-2">
                <!-- stop record -->
                <button
                  class="btn btn-disabled btn-error hidden rounded-lg !text-white"
                  id="stopListening"
                  onclick="my_modal_1.showModal()"
                >
                  <i class="fa-solid fa-stop fa-sm" style="color: #ffffff"></i>
                  Stop
                </button>

                <!-- pause record -->
                <button
                  class="btn btn-info hidden rounded-lg !text-white"
                  id="pauseListening"
                  onclick="startAndStopListening('pause')"
                >
                  <i class="fa-solid fa-pause fa-sm" style="color: #ffffff"></i>
                  Pause
                </button>
              </div>
              <button
                class="btn btn-circle btn-outline btn-sm"
                onclick="scrollToBottom()"
              >
                <i class="fa-solid fa-angles-down"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- right side -->
      <div class="mx-auto flex w-[65%]" id="rideSide">
        <!-- time picker -->
        <div class="w-full">
          <form class="flex justify-between p-6 pb-4" id="formheight">
            <div class="flex gap-2">
              <input
                type="time"
                id="time_1"
                class="block w-fit rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm leading-none text-gray-900 focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-blue-500 dark:focus:ring-blue-500"
                required
              />
              <input
                type="time"
                id="time_2"
                class="block w-fit rounded-lg border border-gray-300 bg-gray-50 p-2.5 text-sm leading-none text-gray-900 focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-blue-500 dark:focus:ring-blue-500"
                required
              />
            </div>
            <button
              class="btn btn-outline btn-primary h-full w-fit min-w-[188px] rounded-lg"
              type="button"
              onclick="summarize('/api/sac/summarize')"
              id="summarizeButton"
            >
              <i
                class="fa-solid fa-wand-magic-sparkles fa-sm !fill-neutral"
              ></i>
              Summarize with AI
            </button>
          </form>

          <!-- preview area -->
          <div class="flex">
            <div
              class="ml-6 h-[calc(100vh-88px-24px)] w-1/2 overflow-auto rounded-l-xl border-2 border-gray-300 p-6"
            >
              <p class="text-gray-400" id="preview">
                Transcription summary with selected time will appear here
              </p>
            </div>
            <!-- summary area -->
            <div
              class="mr-6 h-[calc(100vh-88px-24px)] w-1/2 overflow-auto rounded-r-xl border-2 border-l-0 border-gray-300 p-6"
            >
              <p class="text-gray-400" id="summary">
                Transcription summary with selected time will appear here
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- stop listening modal -->
      <dialog id="my_modal_1" class="modal">
        <div class="modal-box rounded-lg">
          <p class="py-4">Are you sure you want to "Stop Listening"?</p>
          <div class="modal-action">
            <form method="dialog" class="space-x-1">
              <button
                class="btn btn-outline btn-error btn-sm rounded-lg hover:!text-white"
                onclick="startAndStopListening('stop')"
              >
                Yes
              </button>
              <button class="btn btn-outline btn-sm rounded-lg">Cancel</button>
            </form>
          </div>
        </div>
      </dialog>
    </section>

    <!-- alert -->
    <div class="hidden" id="alert">
      <div class="hidden" id="onerror">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span
          >The WebSocket connection is error. Please contact
          administrator.</span
        >
      </div>
      <div class="hidden" id="onclose">
        <i class="fa-solid fa-triangle-exclamation"></i>
        <span>The WebSocket connection is closed. Please start again.</span>
      </div>
    </div>
  </body>
</html>

<script>
  let ws = null;
  let micStream = null;
  let audioContext = null;
  let micProcessor = null;
  let isAlreadyStart = false;

  // scroll to bottom
  let transcriptionDiv = document.getElementById("transcription");

  function scrollToBottom() {
    transcriptionDiv.scrollTop = transcriptionDiv.scrollHeight;
  }

  // summarizer
  async function summarize(slug) {
    const loadingDiv = `<span class="loading loading-spinner loading-md"></span>`;
    const previewDiv = document.getElementById("preview");
    const summaryDiv = document.getElementById("summary");
    const summarizeButtonDiv = document.getElementById("summarizeButton");
    previewDiv.innerHTML = loadingDiv;
    summaryDiv.innerHTML = loadingDiv;
    summarizeButtonDiv.classList.add("btn-disabled");
    summarizeButtonDiv.innerHTML = `<span class="loading loading-spinner"></span>`;
    const text =
      "Siang-malam, ku selalu Menatap layar terpaku Untuk online, online Online, online Tidur telat, bangun pagi-pagi Nyalain komputer, online lagi Bukan mau ngetik kerjaan E-mail tugas diserahkan Tapi malah buka Facebook Padahal face masih ngantuk Beler kayak orang mabuk Pala naik-turun, ngangguk-ngangguk Sambil nge-download mp3 Colok iPod USB kiri Ngecekin postingan forum Apa ada balesannya, belum Biar belum sikat gigi, belum mandi Tapi kalo belum online paling anti Liat Friendster, Myspace, YouTube Me and him, everybody, you too Siang-malam, ku selalu Menatap layar terpaku Untuk online, online Online, online Jari dan keyboard beradu Pasang earphone, dengar lagu Aku online, online Online, online Nah, udah mandi, siap berangkat Langsung cabut, takut terlambat Tak lupa flash disk gantung di leher Malah lupa sepatu, jadi nyeker Flashdisk isinya bokep atau lagu Kalau ada kerjaan pun gue ragu Kalo emang berani, coba pada ngaku Cek isi foldernya satu-satu Di kantor, online pakai proksi Walau diblok server, bisa dilolosi Namanya udah ketagihan internet Produktivitas pun kepepet Jam kerja malah chatting YM Ngobrol online sama eh-he-hem Atasan lewat, langsung klik data Pura-pura kerja di depan mata Siang-malam, ku selalu Menatap layar terpaku Untuk online, online Online, online Jari dan keyboard beradu Pasang earphone, dengar lagu Aku online, online Online, online Makan siang pun aku cari sinyal Wi-Fi Mengapa ku kecanduan? Oh, why, why? Kadang terasa bagai tak berdaya Ingin ku berubah Cek e-mail, spam semua E-mail benerannya cuma dua Yang satu, email lama Yang satu, forward-an yang sama Ngarep komentar, buka Friendster Loading, gue tinggal beser Pas balik, ngecek komputer Kok lagi maintenance server Ya udah, download lagu Bajakan gratis, gak pake ragu Saykoji satu album Setengah jam bisa rampung Sore-sore bosen hambar Ide nakal, cari-cari gambar Download video dengan sabar Ketahuan pacar, digampar Siang-malam, ku selalu Menatap layar terpaku Untuk online, online Online, online Jari dan keyboard beradu Pasang earphone, dengar lagu Aku online, online Online, online Siang-malam, ku selalu Menatap layar terpaku Untuk online, online Online, online Jari dan keyboard beradu Pasang earphone, dengar lagu Aku online, online Online, online";

    try {
      var formData = new FormData();
      formData.append("raw_input", text);
      const response = await fetch(`http://192.168.1.50:19110${slug}`, {
        method: "POST",
        body: formData,
      });
      const result = await response.json();
      previewDiv.innerHTML = text;
      summaryDiv.innerHTML = JSON.stringify(result.result.response);
      previewDiv.classList = "text-black";
      summaryDiv.classList = "text-black";
    } catch (e) {
      console.error(e);
    } finally {
      summarizeButtonDiv.innerHTML = `
      <i
        class="fa-solid fa-wand-magic-sparkles fa-sm !fill-neutral"
      ></i>
      Summarize with AI
      `;
      summarizeButtonDiv.classList.remove("btn-disabled");
    }
  }

  // clear audio
  async function cleanupAudioResources() {
    if (micProcessor) {
      micProcessor.disconnect();
      micProcessor = null;
    }
    if (micStream) {
      micStream.getTracks().forEach((track) => track.stop());
      micStream = null;
    }
    if (audioContext && audioContext.state !== "closed") {
      await audioContext.close();
      audioContext = null;
    }
  }

  // start and stop listening
  async function startAndStopListening(command) {
    const startListening = document.getElementById("startListening");
    const stopListening = document.getElementById("stopListening");
    const pauseListening = document.getElementById("pauseListening");

    // reset websocket
    async function resetWebSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) ws.close();
      ws = null;
    }

    // handle stop button ui
    async function handleStop() {
      startListening.classList.remove("hidden");
      startListening.innerHTML = `
      <i class="fa-solid fa-microphone fa-sm" style="color: #ffffff"></i> Start
      Listening
      `;
      stopListening.classList.add("hidden");
      pauseListening.classList.add("hidden");
    }

    // display date and time badge
    let getDateDiv = document.getElementById("getDate");
    getDateDiv.innerHTML = `<div class="badge badge-ghost">${new Date().toString().split(" GMT")[0]}</div>`;

    // initiate websocket
    async function initWebSocket() {
      if (!ws) {
        ws = new WebSocket("ws://localhost:8000/aws-browser-transcribe");

        ws.onmessage = (event) => {
          const interimDiv = document.getElementById("interim");
          const finalDiv = document.getElementById("final");

          if (event.data === "listening") {
            interimDiv.innerHTML = `<span class="loading loading-dots loading-md text-gray-500"></span>`;
            // transcriptionDiv.scrollTop = transcriptionDiv.scrollHeight;
          } else {
            const transcriptChar = JSON.parse(event.data);
            finalDiv.innerHTML += `
            <p>
              <span class="font-semibold">${transcriptChar.transcription}</span>
              <br />
              <span class="text-xs text-gray-500"
                >${new Date().toString().split(" GMT")[0]}</span
              >
            </p>
            <br />
            `;
            interimDiv.innerHTML = "";
            // transcriptionDiv.scrollTop = transcriptionDiv.scrollHeight;
          }
        };
      }

      onAlertDiv = document.getElementById("alert");
      onErrorDiv = document.getElementById("onerror");
      onCloseDiv = document.getElementById("onclose");

      ws.onerror = async () => {
        onAlertDiv.className = "toast";
        onErrorDiv.className =
          "alert alert-error flex gap-2 fill-white text-white rounded-lg text-sm";
        // getDateDiv.innerHTML = "";

        setTimeout(() => {
          onErrorDiv.className = "hidden";
          onAlertDiv.className = "hidden";
        }, 5000);

        await cleanupAudioResources();
        await handleStop();
        await resetWebSocket();
      };

      ws.onclose = async () => {
        onAlertDiv.className = "toast";
        onCloseDiv.className =
          "alert alert-warning flex gap-2 fill-black text-black rounded-lg text-sm";
        // getDateDiv.innerHTML = "";

        setTimeout(() => {
          onCloseDiv.className = "hidden";
          onAlertDiv.className = "hidden";
        }, 5000);

        await cleanupAudioResources();
        await handleStop();
        await resetWebSocket();
      };
    }

    async function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
          sampleRate: 16000,
        });
      }
    }

    if (command === "start") {
      startListening.classList.add("hidden");
      stopListening.classList.remove("btn-disabled", "hidden");
      pauseListening.classList.remove("hidden", "btn-disabled");

      // start websocket and activate microphone
      try {
        if (isAlreadyStart === false) {
          await resetWebSocket();
          await initWebSocket();
        }
        await cleanupAudioResources();
        await initAudio();

        micStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });
        const source = audioContext.createMediaStreamSource(micStream);
        micProcessor = audioContext.createScriptProcessor(4096, 1, 1);
        source.connect(micProcessor);
        micProcessor.connect(audioContext.destination);

        micProcessor.onaudioprocess = (e) => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            const inputData = e.inputBuffer.getChannelData(0);
            const samples = new Int16Array(inputData.length);
            for (let i = 0; i < inputData.length; i++) {
              samples[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7fff;
            }
            ws.send(samples.buffer);
          }
        };
      } catch (error) {
        console.error(error);
        await cleanupAudioResources();
      }
    }

    // stop microphone
    else if (command === "stop") {
      isAlreadyStart = false;
      await cleanupAudioResources();
      await resetWebSocket();
      await handleStop();
    }

    // pause microphone
    else if (command === "pause") {
      isAlreadyStart = true;
      if (micStream) {
        micStream.getTracks().forEach((track) => track.stop());
        micStream = null;
      }
      startListening.classList.remove("hidden");
      startListening.innerHTML = `
      <i class="fa-solid fa-play fa-sm" style="color: #ffffff"></i>
      Continue Listening
      `;
      stopListening.classList.add("hidden");
      pauseListening.classList.add("hidden");
    }
  }
</script>
