<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speech to Text</title>

    <link href="./input.css" rel="stylesheet" />
    <link href="./output.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
  </head>
  <body>
    <section class="flex justify-center">
      <!-- left -->
      <div class="relative min-w-[25%] duration-300 ease-in-out" id="myTopnav">
        <div class="fixed min-w-[25%]">
          <div class="mx-auto flex h-screen max-w-[85%] flex-col gap-12 pt-8">
            <!-- logo -->
            <img
              src="https://www.spil.co.id/img/spil_logo.581f4306.svg"
              width="50"
            />

            <!-- live transcript menu -->
            <div class="space-y-4">
              <ul class="menu w-full rounded-box bg-base-200">
                <li>
                  <h2 class="menu-title">Live Transcript</h2>
                  <ul>
                    <li>
                      <button>Amazon Web Service (AWS)</button>
                    </li>
                    <li><button>Vertex AI</button></li>
                  </ul>
                </li>
              </ul>

              <!-- recorded transcript menu -->
              <ul class="menu w-full rounded-box bg-base-200">
                <li>
                  <h2 class="menu-title">Recorded Transcript</h2>
                  <ul>
                    <li><button>URL</button></li>
                    <li><button>Audio File</button></li>
                  </ul>
                </li>
              </ul>
            </div>

            <!-- copyright -->
            <p
              class="absolute bottom-8 left-1/2 -translate-x-1/2 transform text-sm"
            >
              Â© 2025 PT SPIL
            </p>
          </div>
        </div>
      </div>

      <!-- right -->
      <div class="flex w-full flex-col gap-10 p-8">
        <!-- navbar -->
        <nav
          class="navbar sticky top-8 z-50 gap-2 rounded-3xl bg-base-100 p-4 shadow-lg"
        >
          <!-- start record -->
          <div class="flex-none">
            <button
              class="btn btn-primary rounded-2xl"
              onclick="startStopAudio('start')"
              id="startListening"
            >
              <i
                class="fa-solid fa-microphone fa-sm"
                style="color: #ffffff"
              ></i>
              Start Listening with Vertex
            </button>
          </div>
          <!-- stop record -->
          <div class="flex-1">
            <button
              class="btn btn-disabled btn-error rounded-2xl !text-white"
              onclick="startStopAudio('stop')"
              id="stopListening"
            >
              <i class="fa-solid fa-stop fa-sm" style="color: #ffffff"></i>
              Stop Listening
            </button>
          </div>
          <!-- hamburger menu -->
          <div class="flex-none">
            <button class="btn btn-square rounded-xl" onclick="openCloseNav()">
              <i class="fa-solid fa-bars" style="color: #000000"></i>
            </button>
          </div>
        </nav>

        <!-- transcription result -->
        <div class="mx-auto w-[600px]">
          <div class="w-full space-y-4">
            <div class="flex items-center gap-4">
              <div class="avatar placeholder h-fit w-fit">
                <div class="w-10 rounded-full bg-neutral text-neutral-content">
                  <i
                    class="fa-solid fa-calendar fa-sm"
                    style="color: #ffffff"
                  ></i>
                </div>
              </div>
              <p class="text-sm" id="getDate"></p>
            </div>
            <p class="text-sm">
              <span id="final" class="font-semibold"></span>
              <span id="interim"></span>
            </p>
          </div>
        </div>
      </div>
    </section>
  </body>
</html>

<script>
  let socket = null;

  // open close navbar
  function openCloseNav() {
    var x = document.getElementById("myTopnav");
    var before = "relative min-w-[25%] ";
    var delay = "duration-300 ease-in-out";
    if (x.className === before + delay) {
      x.className = "fixed translate-x-[-100%] w-full " + delay;
    } else {
      x.className = before + delay;
    }
  }

  function startStopAudio(command) {
    // start and stop websocket
    if (socket) {
      if (socket.readyState === WebSocket.OPEN) {
        if (command === "stop") {
          socket.send("stop");
          setTimeout(() => {
            socket.close();
          }, 1000);
        }
      } else {
        console.log("cannot send stop command because websocket is not open");
      }
    } else {
      socket = new WebSocket("ws://localhost:8765");

      socket.onopen = () => {
        console.log("connected to server!");
        if (command === "start") {
          socket.send("start");
        }
      };

      // live transcript
      let lastTranscript = "";

      socket.onmessage = (event) => {
        const transcriptChar = event.data;

        if (transcriptChar !== lastTranscript) {
          lastTranscript = transcriptChar;
          if (transcriptChar.slice(0, 6) === "final:") {
            const finalDiv = document.getElementById("final");
            finalDiv.innerHTML += transcriptChar.slice(7);
            finalDiv.scrollTop = finalDiv.scrollHeight;
          } else {
            const interimDiv = document.getElementById("interim");
            interimDiv.textContent = transcriptChar;
            interimDiv.scrollTop = interimDiv.scrollHeight;
          }
        }
      };
    }

    // start and stop button interface
    const startListening = document.getElementById("startListening");
    const stopListening = document.getElementById("stopListening");

    if (command === "start") {
      startListening.classList.add("hidden");
      stopListening.classList.remove("btn-disabled");
    } else if (command === "stop") {
      startListening.classList.remove("hidden");
      stopListening.classList.add("btn-disabled");
    }

    document.getElementById("getDate").innerHTML = new Date();
  }
</script>
