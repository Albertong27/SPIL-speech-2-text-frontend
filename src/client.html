<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speech to Text</title>

    <!-- tailwind -->
    <link href="./input.css" rel="stylesheet" />
    <link href="./output.css" rel="stylesheet" />

    <!-- font poppins and roboto mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- font awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
  </head>

  <body class="font-poppins">
    <!-- log preview -->
    <section
      class="fixed bottom-0 z-40 hidden h-[50vh] w-full overflow-auto bg-[#F9F9F9]"
      id="logPreview"
    >
      <p class="mx-auto w-[500px] py-8 text-center" id="interim"></p>
    </section>

    <section class="flex justify-center">
      <!-- left -->
      <div class="relative min-w-[25%] duration-300 ease-in-out" id="myTopnav">
        <div class="fixed min-w-[25%]">
          <div class="mx-auto flex h-screen max-w-[85%] flex-col gap-12 pt-8">
            <!-- logo -->
            <img
              src="https://www.spil.co.id/img/spil_logo.581f4306.svg"
              width="50"
            />

            <!-- live transcript menu -->
            <div class="space-y-4">
              <ul class="menu w-full rounded-box bg-base-200">
                <li>
                  <h2 class="menu-title">Live Transcript</h2>
                  <ul>
                    <li>
                      <button class="active">Amazon Web Service (AWS)</button>
                    </li>
                    <li><button>Vertex AI</button></li>
                  </ul>
                </li>
              </ul>

              <!-- recorded transcript menu -->
              <ul class="menu w-full rounded-box bg-base-200">
                <li>
                  <h2 class="menu-title">Recorded Transcript</h2>
                  <ul>
                    <li><button>URL</button></li>
                    <li><button>Audio File</button></li>
                  </ul>
                </li>
              </ul>
            </div>

            <!-- copyright -->
            <p
              class="absolute bottom-8 left-1/2 -translate-x-1/2 transform text-sm"
            >
              Â© 2025 PT SPIL
            </p>
          </div>
        </div>
      </div>

      <!-- right -->
      <div class="mx-auto flex w-full flex-col gap-10 p-8">
        <!-- navbar -->
        <nav
          class="navbar sticky top-8 z-30 flex gap-2 rounded-3xl bg-base-100 p-4 shadow-lg"
        >
          <!-- hamburger menu -->
          <div class="navbar-start">
            <button class="btn btn-square rounded-xl" onclick="openClose.Nav()">
              <i class="fa-solid fa-bars" style="color: #000000"></i>
            </button>
          </div>

          <div class="navbar-center">
            <!-- start record -->
            <button
              class="btn btn-primary flex-none rounded-2xl"
              id="startListening"
              onclick="startStopAudio('start')"
            >
              <i
                class="fa-solid fa-microphone fa-sm"
                style="color: #ffffff"
              ></i>
              Start Listening with AWS
            </button>

            <!-- stop record -->
            <button
              class="btn btn-disabled btn-error mr-2 hidden rounded-2xl !text-white"
              id="stopListening"
              onclick="my_modal_1.showModal()"
            >
              <i class="fa-solid fa-stop fa-sm" style="color: #ffffff"></i>
              Stop Listening
            </button>

            <!-- pause record -->
            <button
              class="btn btn-info hidden rounded-xl !text-white"
              id="pauseListening"
              onclick="startStopAudio('pause')"
            >
              <i class="fa-solid fa-pause fa-sm" style="color: #ffffff"></i>
              Pause Listening
            </button>
          </div>

          <div class="navbar-end">
            <button
              class="btn btn-square btn-neutral z-50 flex-none rounded-xl"
              onclick="openClose.logPreview()"
            >
              <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
          </div>
        </nav>

        <!-- transcription result -->
        <div class="mx-auto flex w-[500px] gap-8" id="transcription">
          <div class="flex w-full gap-4">
            <div class="space-y-6 text-justify">
              <div id="getDate"></div>
              <p><span class="font-semibold" id="final"></span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- stop listening modal -->
      <dialog id="my_modal_1" class="modal">
        <div class="modal-box">
          <p class="py-4">Are you sure you want to "Stop Listening"?</p>
          <div class="modal-action">
            <form method="dialog" class="space-x-1">
              <button
                class="btn btn-outline btn-error rounded-2xl hover:!text-white"
                onclick="startStopAudio('stop')"
              >
                Yes
              </button>
              <button class="btn rounded-xl">Close</button>
            </form>
          </div>
        </div>
      </dialog>
    </section>
  </body>
</html>

<script>
  let ws = null;
  let micStream = null;
  let audioContext = null;
  let micProcessor = null;

  const openClose = (function () {
    // open close navbar
    function Nav() {
      var x = document.getElementById("myTopnav");
      var before = "relative min-w-[25%] ";
      var delay = "duration-300 ease-in-out";

      x.className === before + delay
        ? (x.className = "fixed translate-x-[-100%] w-full " + delay)
        : (x.className = before + delay);
    }

    // open close log preview
    function logPreview() {
      var x = document.getElementById("logPreview");
      var before =
        "fixed bottom-0 z-40 hidden h-[50vh] w-full overflow-auto bg-[#F9F9F9]";

      x.className === before
        ? x.classList.remove("hidden")
        : (x.className = before);
    }

    return {
      Nav,
      logPreview,
    };
  })();

  async function cleanupAudioResources() {
    if (micProcessor) {
      micProcessor.disconnect();
      micProcessor = null;
    }
    if (micStream) {
      micStream.getTracks().forEach((track) => track.stop());
      micStream = null;
    }
    if (audioContext && audioContext.state !== "closed") {
      await audioContext.close();
      audioContext = null;
    }
  }

  async function startStopAudio(command) {
    // start and stop button interface
    const startListening = document.getElementById("startListening");
    const stopListening = document.getElementById("stopListening");
    const pauseListening = document.getElementById("pauseListening");

    document.getElementById("getDate").innerHTML = `
    <div class="space-y-4">
      <div class="flex items-center gap-3">
        <div class="avatar placeholder h-fit w-fit">
          <div class="w-10 rounded-full bg-neutral text-neutral-content">
            <i class="fa-solid fa-calendar fa-sm" style="color: #ffffff"></i>
          </div>
        </div>
        <p class="text-sm">${new Date().toString().split(" GMT")[0]}</p>
      </div>
    </div>
    `;

    async function initWebSocket() {
      if (!ws) {
        ws = new WebSocket("ws://localhost:8000/aws-browser-transcribe");

        // live transcript
        let lastTranscript = "";

        ws.onmessage = (event) => {
          const transcriptChar = event.data;

          if (transcriptChar !== lastTranscript) {
            lastTranscript = transcriptChar.toLowerCase();
            console.log(lastTranscript);
            if (transcriptChar.slice(0, 6) === "final:") {
              const finalDiv = document.getElementById("final");
              finalDiv.innerHTML += transcriptChar.slice(6);
              finalDiv.scrollTop = finalDiv.scrollHeight;
            } else {
              const interimDiv = document.getElementById("interim");
              interimDiv.innerHTML += `
              <p class="space-y-2">
                <span class="font-semibold">${transcriptChar}</span> 
                <br /> 
                <span class="text-xs font-gray-500">${new Date().toString().split(" GMT")[0]}</span>
              </p> 
              </br />
              `;
              interimDiv.scrollTop = interimDiv.scrollHeight;
            }
          }
        };
      }

      ws.onclose = () => {
        console.log("Websocket closed");
      };

      ws.onerror = () => {
        console.log("Websocket error");
      };
    }

    async function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
          sampleRate: 16000,
        });
      }
    }

    if (command === "start") {
      // button action
      startListening.classList.add("hidden");
      stopListening.classList.remove("btn-disabled", "hidden");
      pauseListening.classList.remove("hidden", "btn-disabled");

      // start websocket and activate microphone
      try {
        await cleanupAudioResources();
        await initWebSocket();

        await initAudio();
        micStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });

        const source = audioContext.createMediaStreamSource(micStream);
        micProcessor = audioContext.createScriptProcessor(4096, 1, 1);

        source.connect(micProcessor);
        micProcessor.connect(audioContext.destination);

        micProcessor.onaudioprocess = (e) => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            const inputData = e.inputBuffer.getChannelData(0);
            const samples = new Int16Array(inputData.length);
            for (let i = 0; i < inputData.length; i++) {
              samples[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7fff;
            }
            ws.send(samples.buffer);
          }
        };
      } catch (error) {
        console.error(error);
        await cleanupAudioResources();
      }
    }

    // stop microphone
    else if (command === "stop") {
      await cleanupAudioResources();
      await initWebSocket();
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.close();
        ws = null;
      }

      // button
      startListening.classList.remove("hidden");
      startListening.innerHTML = `
      <i
        class="fa-solid fa-microphone fa-sm"
        style="color: #ffffff"
      ></i>
      Start Listening with AWS
    `;
      stopListening.classList.add("hidden");
      pauseListening.classList.add("hidden");
    }

    // pause microphone
    else if (command === "pause") {
      // microphone
      if (micStream) {
        micStream.getTracks().forEach((track) => track.stop());
        micStream = null;
      }

      // button
      startListening.classList.remove("hidden");
      startListening.innerHTML = `
      <i
        class="fa-solid fa-play fa-sm"
        style="color: #ffffff"
      ></i>
      Continue Listening with AWS
    `;
      stopListening.classList.add("hidden");
      pauseListening.classList.add("hidden");
    }
  }
</script>
