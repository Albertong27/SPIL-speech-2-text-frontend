<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Speech to Text</title>

    <!-- tailwind -->
    <link href="./input.css" rel="stylesheet" />
    <link href="./output.css" rel="stylesheet" />

    <!-- font poppins and roboto mono -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
      rel="stylesheet"
    />

    <!-- font awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    />
  </head>

  <body class="font-poppins">
    <section class="flex">
      <!-- left side -->
      <div
        class="flex h-screen w-2/5 flex-col rounded-r-3xl border-2 border-gray-200"
      >
        <div class="relative w-full overflow-auto">
          <!-- search bar -->
          <div class="relative h-[15vh]">
            <div
              class="fixed flex h-[15vh] w-2/5 items-center justify-center px-10"
            >
              <label
                class="input input-bordered flex w-full items-center gap-2 rounded-xl"
              >
                <input type="text" class="grow" placeholder="Search" />
                <i class="fas fa-search fa-sm" style="color: #697079"></i>
              </label>
            </div>
          </div>

          <!-- transcription result -->
          <div class="h-[70vh] px-10" id="transcription">
            <div class="flex gap-4">
              <div class="space-y-6">
                <div id="getDate"></div>
                <p>
                  <span class="font-semibold" id="final"></span>
                  <span class="text-gray-300" id="interim"></span>
                </p>
              </div>
            </div>
          </div>

          <div class="fixed bottom-0 h-[15vh] w-2/5 rounded-br-3xl">
            <div class="flex h-[15vh] items-center justify-between px-10">
              <!-- start record -->
              <button
                class="btn btn-primary w-fit flex-none rounded-2xl"
                id="startListening"
                onclick="startAndStopListening('start')"
              >
                <i
                  class="fa-solid fa-microphone fa-sm"
                  style="color: #ffffff"
                ></i>
                Start Listening with AWS
              </button>

              <div class="flex gap-2">
                <!-- stop record -->
                <button
                  class="btn btn-disabled btn-error hidden rounded-2xl !text-white"
                  id="stopListening"
                  onclick="my_modal_1.showModal()"
                >
                  <i class="fa-solid fa-stop fa-sm" style="color: #ffffff"></i>
                  Stop Listening
                </button>

                <!-- pause record -->
                <button
                  class="btn btn-info hidden rounded-2xl !text-white"
                  id="pauseListening"
                  onclick="startAndStopListening('pause')"
                >
                  <i class="fa-solid fa-pause fa-sm" style="color: #ffffff"></i>
                  Pause Listening
                </button>
              </div>

              <div>
                <button class="btn btn-square z-50 rounded-xl">
                  <i class="fa-solid fa-clock-rotate-left"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- right side -->
      <div class="w-3/5">
        <!-- time picker -->
        <form
          class="flex h-[15vh] flex-col items-center justify-center gap-4 px-8"
        >
          <div class="flex w-full gap-2">
            <input
              type="time"
              id="time_1"
              class="block w-full rounded-xl border border-gray-300 bg-gray-50 p-2.5 text-sm leading-none text-gray-900 focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-blue-500 dark:focus:ring-blue-500"
              required
            />
            <input
              type="time"
              id="time_2"
              class="block w-full rounded-xl border border-gray-300 bg-gray-50 p-2.5 text-sm leading-none text-gray-900 focus:border-blue-500 focus:ring-blue-500 dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400 dark:focus:border-blue-500 dark:focus:ring-blue-500"
              required
            />
            <button
              class="btn btn-outline btn-primary w-1/3 rounded-xl"
              type="submit"
            >
              <i
                class="fa-solid fa-wand-magic-sparkles fa-sm !fill-primary"
              ></i>
              Summarize with AI
            </button>
          </div>
        </form>

        <!-- text area -->
        <div class="flex h-[77.5vh] w-full px-8">
          <div
            class="h-[77.5vh] w-full rounded-l-xl border-2 border-gray-200 p-6"
          >
            <p class="text-sm text-gray-400">
              Transcription preview with selected time will appear here
            </p>
          </div>
          <div
            class="h-[77.5vh] w-full rounded-r-xl border-2 border-l-0 border-gray-200 p-6"
          >
            <p class="text-sm text-gray-400">
              Transcription summary with selected time will appear here
            </p>
          </div>
        </div>

        <!-- copyright -->
        <div class="flex h-[7.5vh] items-center px-8">
          <p class="w-full text-center text-sm text-gray-700">
            Â© PT SPIL 2025
          </p>
        </div>
      </div>

      <!-- stop listening modal -->
      <dialog id="my_modal_1" class="modal">
        <div class="modal-box">
          <p class="py-4">Are you sure you want to "Stop Listening"?</p>
          <div class="modal-action">
            <form method="dialog" class="space-x-1">
              <button
                class="btn btn-outline btn-error rounded-2xl hover:!text-white"
                onclick="startAndStopListening('stop')"
              >
                Yes
              </button>
              <button class="btn rounded-xl">Close</button>
            </form>
          </div>
        </div>
      </dialog>

      <!-- alert -->
      <div id="alert"></div>
    </section>
  </body>
</html>

<script>
  let ws = null;
  let micStream = null;
  let audioContext = null;
  let micProcessor = null;

  // clear audio
  async function cleanupAudioResources() {
    if (micProcessor) {
      micProcessor.disconnect();
      micProcessor = null;
    }
    if (micStream) {
      micStream.getTracks().forEach((track) => track.stop());
      micStream = null;
    }
    if (audioContext && audioContext.state !== "closed") {
      await audioContext.close();
      audioContext = null;
    }
  }

  // start and stop listening
  async function startAndStopListening(command) {
    const startListening = document.getElementById("startListening");
    const stopListening = document.getElementById("stopListening");
    const pauseListening = document.getElementById("pauseListening");

    // reset websocket
    async function resetWebSocket() {
      if (ws && ws.readyState === WebSocket.OPEN) ws.close();
      ws = null;
    }

    // handle stop button ui
    async function handleStop() {
      startListening.classList.remove("hidden");
      startListening.innerHTML = `
      <i class="fa-solid fa-microphone fa-sm" style="color: #ffffff"></i> Start
      Listening with AWS
      `;
      stopListening.classList.add("hidden");
      pauseListening.classList.add("hidden");
    }

    // display date and time badge
    document.getElementById("getDate").innerHTML =
      `<div class="badge badge-ghost">${new Date().toString().split(" GMT")[0]}</div>`;

    // initiate websocket
    async function initWebSocket() {
      if (!ws) {
        ws = new WebSocket("ws://localhost:8000/aws-browser-transcribe");

        let lastTranscript = "";

        ws.onmessage = (event) => {
          const transcriptChar = event.data;

          lastTranscript = transcriptChar;
          console.log(lastTranscript);
          console.log(transcriptChar);
          if (transcriptChar.slice(0, 14) === "transcription:") {
            const finalDiv = document.getElementById("final");
            finalDiv.innerHTML += `
            <p>
              <span class="font-semibold">${transcriptChar.slice(14)}</span>
              <br />
              <span class="text-xs text-gray-500"
                >${new Date().toString().split(" GMT")[0]}</span
              >
            </p>
            <br />
            `;
            finalDiv.scrollTop = finalDiv.scrollHeight;
          } else {
            const interimDiv = document.getElementById("interim");
            interimDiv.innerHTML = `${transcriptChar} `;
            interimDiv.scrollTop = interimDiv.scrollHeight;
          }
        };
      }

      alertDiv = document.getElementById("alert");

      ws.onerror = async () => {
        alertDiv.innerHTML = `
        <div class="toast toast-center toast-top">
          <div class="alert alert-error flex gap-2 fill-white text-white">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span
              >The WebSocket connection is error. Please contact administrator.</span
            >
          </div>
        </div>
        `;

        setTimeout(() => {
          alertDiv.innerHTML = "";
        }, 5000);

        await resetWebSocket();
        await handleStop();
      };

      ws.onclose = async () => {
        alertDiv.innerHTML = `
        <div class="toast toast-center toast-top">
          <div class="alert alert-warning flex gap-2 fill-black text-black">
            <i class="fa-solid fa-triangle-exclamation"></i>
            <span
              >The WebSocket connection was automatically closed. Please start
              again.</span
            >
          </div>
        </div>
        `;

        setTimeout(() => {
          alertDiv.innerHTML = "";
        }, 5000);

        await resetWebSocket();
        await handleStop();
      };
    }

    async function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)({
          sampleRate: 16000,
        });
      }
    }

    if (command === "start") {
      startListening.classList.add("hidden");
      stopListening.classList.remove("btn-disabled", "hidden");
      pauseListening.classList.remove("hidden", "btn-disabled");

      // start websocket and activate microphone
      try {
        await cleanupAudioResources();
        await resetWebSocket();
        await initWebSocket();
        await initAudio();
        micStream = await navigator.mediaDevices.getUserMedia({
          audio: true,
        });

        const source = audioContext.createMediaStreamSource(micStream);
        micProcessor = audioContext.createScriptProcessor(4096, 1, 1);

        source.connect(micProcessor);
        micProcessor.connect(audioContext.destination);

        micProcessor.onaudioprocess = (e) => {
          if (ws && ws.readyState === WebSocket.OPEN) {
            const inputData = e.inputBuffer.getChannelData(0);
            const samples = new Int16Array(inputData.length);
            for (let i = 0; i < inputData.length; i++) {
              samples[i] = Math.max(-1, Math.min(1, inputData[i])) * 0x7fff;
            }
            ws.send(samples.buffer);
          }
        };
      } catch (error) {
        console.error(error);
        await cleanupAudioResources();
      }
    }

    // stop microphone
    else if (command === "stop") {
      await cleanupAudioResources();
      await resetWebSocket();
      await handleStop();
    }

    // pause microphone
    else if (command === "pause") {
      if (micStream) {
        micStream.getTracks().forEach((track) => track.stop());
        micStream = null;
      }

      startListening.classList.remove("hidden");
      startListening.innerHTML = `
      <i class="fa-solid fa-play fa-sm" style="color: #ffffff"></i>
      Continue Listening with AWS
      `;
      stopListening.classList.add("hidden");
      pauseListening.classList.add("hidden");
    }
  }
</script>
